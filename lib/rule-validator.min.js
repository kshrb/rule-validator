/*! rule-validator 
 version : 1.0.0 
 Build on : 2017-04-19 16:04:54 */

!function(){"use strict";function a(a,b){return this.init(),void 0!==a&&this.register(a),b&&(this.ignoreFactChanges=b.ignoreFactChanges),this}var b=require("underscore");exports.version="1.0.0",a.prototype.init=function(){this.rules=[],this.activeRules=[]},a.prototype.register=function(a){Array.isArray(a)?this.rules=this.rules.concat(a):null!==a&&"object"==typeof a&&this.rules.push(a),this.sync()},a.prototype.sync=function(){this.activeRules=this.rules.filter(function(a){if(void 0===a.on&&(a.on=!0),!0===a.on)return a}),this.activeRules.sort(function(a,b){return a.priority&&b.priority?b.priority-a.priority:0})},a.prototype.execute=function(a,c){var d=!1;a.result=!0;var e=b.clone(a),f=b.clone(a),g=this.activeRules,h=[],i=this.ignoreFactChanges;!function a(j){var k={rule:function(){return g[j]},when:function(a){if(a){var b=g[j].consequence;b.ruleRef=g[j].id||g[j].name||"index_"+j,process.nextTick(function(){h.push(b.ruleRef),b.call(e,k,e)})}else process.nextTick(function(){k.next()})},restart:function(){return new a(0)},stop:function(){return d=!0,new a(0)},next:function(){i||b.isEqual(f,e)?process.nextTick(function(){return new a(j+1)}):(f=b.clone(e),process.nextTick(function(){k.restart()}))}};if(j<g.length&&!1===d){g[j].condition.call(e,k,e)}else process.nextTick(function(){return e.matchPath=h,c(e)})}(0)},a.prototype.findRules=function(a){if(void 0===a)return this.rules;var c=b.matches(a);return b.filter(this.rules,c)},a.prototype.turn=function(a,b){for(var c="on"===a||"ON"===a,d=this.findRules(b),e=0,f=d.length;e<f;e+=1)d[e].on=c;this.sync()},a.prototype.prioritize=function(a,b){a=parseInt(a,10);for(var c=this.findRules(b),d=0,e=c.length;d<e;d+=1)c[d].priority=a;this.sync()},a.prototype.toJSON=function(){var a=this.rules;return a instanceof Array?a=a.map(function(a){return a.condition=a.condition.toString(),a.consequence=a.consequence.toString(),a}):void 0!==a&&(a.condition=a.condition.toString(),a.consequence=a.consequence.toString()),a},module.exports=a}(module.exports);